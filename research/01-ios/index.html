<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!--<meta http-equiv="x-ua-compatible" content="ie=edge, chrome=1" />-->
  <title>untitled</title>
  <link rel="stylesheet" href="" />
</head>

<body>
  <button id="play" disabled>play</button>
  <button id="pause" disabled>pause</button>
  <script src="gmemu-module.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script>
    var INT16_MAX = Math.pow(2, 32) - 1;
    var AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
    var audioContext = new AudioContext();
    var scriptProcessor = audioContext.createScriptProcessor(8192, 2, 2);
    var bufferNode = audioContext.createBufferSource();
    var buffer = audioContext.createBuffer(2, 8192, audioContext.sampleRate);
    var gain = audioContext.createGain();
    var Module = function(Module) {
      return {
        helloWorld: Module.cwrap('gmemujs_test', "string", []),
        initialize: Module.cwrap('initialize', "number", ["number", "number"]),
        openData: Module.cwrap('open_data', "number", ["number", "array", "number"]),
        trackCount: Module.cwrap('track_count', "number", ["number"]),
        openTrack: Module.cwrap('open_track', "number", ["number", "number"]),
        trackInfo: Module.cwrap('track_info', "string", ["number"]),
        trackStart: Module.cwrap('track_start', "number", ["number"]),
        generateSoundData: Module.cwrap('generate_sound_data', "number", ["number"]),
        getValue: Module.getValue.bind(Module)
      };
    }(Module);

    $(window).ready(function() {
      /*
      gme.init();
      gme.load("MegaMan2.nsf", function (file) {
        var track = file.track(10);
        gme.play(track);
      });
      */
      var paused = false;
      $("#pause").click(function() {
        paused = !paused;
        gain.gain.value = paused ? 0 : 1;
      });
      console.log('ready...');
      var _c_albumBuilder = Module.initialize(44100, 8192);
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "MegaMan2.nsf", true);
      xhr.responseType = "arraybuffer";
      xhr.onload = function(e) {
        console.log('loaded...');
        var data = new Uint8Array(this.response);
        var _c_album = Module.openData(_c_albumBuilder, data, data.length);
        var _c_track = Module.openTrack(_c_album, 10);
        var track_info = JSON.parse(Module.trackInfo(_c_track));
        console.log(track_info);
        $("#play").prop('disabled', false).click(function() {
          $("#pause").prop('disabled', false);
          $(this).prop('disabled', false);
          console.log('begin play');
          var _c_playInfo = Module.trackStart(_c_track);

          scriptProcessor.onaudioprocess = function(e) {
            var bufferSize = 8192;
            if (!paused) {
              var buffer = Module.generateSoundData(bufferSize);
              var channels = [e.outputBuffer.getChannelData(0), e.outputBuffer.getChannelData(1)];

            }
            for (var i = 0; i < bufferSize; i++) {
              for (var n = 0; n < e.outputBuffer.numberOfChannels; n++) {
                var value = 0;
                if (!paused) {
                  value = Module.getValue(buffer + i * e.outputBuffer.numberOfChannels * 2 + n * 4, "i32") / INT16_MAX;
                }
                channels[n][i] = value;
              }
            }
          };
          gain.gain.value = 1;
          var data = buffer.getChannelData(0);
          for (var i = 0; i < 8192; i++) {
            data[i] = (Math.random() * 2) - 1;
          }
          var data = buffer.getChannelData(1);
          for (var i = 0; i < 8192; i++) {
            data[i] = (Math.random() * 2) - 1;
          }
          bufferNode.buffer = buffer;
          bufferNode.loop = true;
          bufferNode.connect(scriptProcessor);
          scriptProcessor.connect(gain);
          gain.connect(audioContext.destination);
          bufferNode.noteOn(0);

        });
      };
      xhr.send();
    });
  </script>
</body>

</html>
